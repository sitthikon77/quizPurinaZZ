<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purina | Quiz Game</title>

    <!-- css frameworks -->
    <script src="https://cdn.tailwindcss.com"></script> <!-- tailwind CSS -->
    <link rel="stylesheet" href="style/style.css"> <!-- style CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/dist/css/index.min.css" />
    <!-- tailwind elements CSS -->
    <!-- / css frameworks -->
</head>

<body class="h-screen overflow-hidden flex items-center justify-center bg-black">

    <div class="bg-grey-lighter min-h-screen flex flex-col ">
        <div class="container max-w-sm mx-auto flex-1 flex flex-col items-center justify-center px-2">

            <form class="bg-orange-50 border-8  border-yellow-600  px-14 py-10  shadow-md text-black w-full"
                onsubmit="signup()">
                <h1 class="mb-6 text-2xl text-center font-semibold">Registration</h1>
                <!-- input-Sex -->
                <select  id="prefixName" class="shadow block border-2  border-grey-light w-full p-3 px-4 rounded mb-4 focus:outline-none focus:border-yellow-600 focus:ring-yellow-600">
                    <option class="m-12">Mr.</option>
                    <option class="m-12">Miss</option>
                    <option class="m-12">Mrs.</option>
                </select>
                <!-- input-Fname -->
                <input 
                id="Fname"
                type="text"
                class="shadow block border-2  border-grey-light w-full p-3 px-4 rounded mb-4 focus:outline-none focus:border-yellow-600 focus:ring-yellow-600"
                name="Fname"
                required
                placeholder="Frist Name" />
                <!-- input-Lname -->
                <input 
                id="Lname"
                type="text"
                class="shadow block border-2  border-grey-light w-full p-3 px-4 rounded mb-4 focus:outline-none focus:border-yellow-600 focus:ring-yellow-600"
                name="Lname"
                required
                placeholder="Last Name" />

                <!-- input-phone -->
                <input 
                id="phone"
                type="tel"
                class="shadow block border-2  border-grey-light w-full p-3 rounded mb-4 focus:outline-none focus:border-yellow-600 focus:ring-yellow-600"
                name="phone"
                pattern="[0-9]{10}"
                required
                placeholder="Phone/Mobile" />
                <!-- input-email -->
                <input 
                id="email"
                type="email"
                class="shadow block border-2  border-grey-light w-full p-3 px-4 rounded mb-4 focus:outline-none focus:border-yellow-600 focus:ring-yellow-600"
                name="email"
                 required
                placeholder="Email" />
                    <div class="layout-sign-in">
                    <button class="btn-sign-in" id="btn-submit" type="submit" onclick=""><img
                            src="assets/image/btn-register.svg">
                    </button>
                </div>

            </form>
        </div>
    </div>
    <script>

        function signup(e) {
            event.preventDefault();
            // console.log('working');

            var prefixName = document.getElementById('prefixName').value;
            var name1 = document.getElementById('Fname').value;
            var name2 = document.getElementById('Lname').value;
            var phone = document.getElementById('phone').value;
            var email = document.getElementById('email').value;

            let fullname = prefixName + ' ' + name1 + ' ' + name2
            var data = JSON.stringify({
                "name": fullname,
                "email":email,
                "user_ref": phone,
            });

            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                    console.log(this.responseText);

                    var user_game_id = this.responseText;

                    var obj = JSON.parse(user_game_id);

                    const user_game = obj.user_game_id;

                    var user = {
                        username: name1,
                        user_ref: phone,
                        user_game_id: user_game,
                    };

                    var json = JSON.stringify(user);
                    localStorage.setItem('user_game_id', json);
                    // console.log('user added');

                    // Can play?
                    var xhr_canply = new XMLHttpRequest();
                    xhr_canply.withCredentials = true;

                    xhr_canply.addEventListener("readystatechange", function () {
                        if (this.readyState === 4) {

                            var myJSON = this.responseText;

                            var obj = JSON.parse(myJSON);
                            // console.log(obj);

                            const canPlay = obj.canPlay;
                            console.log(canPlay);

                            // if (typeof canPlay == "boolean") {
                            //     console.log("YES");
                            // }

                            if (canPlay == true) {
                                document.getElementById("btn-submit").onclick = location.href = "quiz.html";
                            } else if (roundCode == null) {
                                alert("วันนี้คุณได้เล่นเกมไปแล้ว กรุณารอวันถัดไป");
                            }else{
                                alert("รอบยังไม่เปิด หรือคุณเล่นไปแล้ว");
                            }

                        }
                    });

                    var retrievedObject = localStorage.getItem('round_code');

                    JSON.parse(retrievedObject);

                    // Remove double quotes from a String
                    var strRoundCode = retrievedObject;
                    const roundCode = strRoundCode.replace(/^"(.*)"$/, '$1');
                    // console.log(roundCode);

                    xhr_canply.open("GET", "https://api.purinaroadshow.rockinevent.com/api/user/round/iscanplay/" + roundCode);
                    xhr_canply.setRequestHeader("Authorization", "Bearer " + user_game);

                    xhr_canply.send();
                }
            });

            xhr.open("POST", "https://api.purinaroadshow.rockinevent.com/api/user/loginOrRegister");
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.send(data);
        };
    </script>
</body>

</html>